import{B as b,d as Z,j as w,r as ee,c as A,C as se,l as te,a as u,o as c,f as q,p as j,F as S,b as s,t as d,e as g,w as oe,h as P,n as R,a7 as ne,A as ie,g as D,a4 as ae,i as le,m as re,v as ue,a8 as ce,_ as de}from"./index-BuxX1puY.js";import{d as pe}from"./questionnaireCreate-Dz9MBAgv.js";const x="http://localhost:8081",M={questionnaire:"/questionnaire/search/{id}",model:"/model/search/{id}",question:"/question/search/{id}",submit:"/questionnaire/answer"},$=new Map;async function V(){try{return(await b.get(`${x}/health`,{timeout:3e3,headers:{"Content-Type":"application/json"}})).status===200}catch(l){return console.warn("API connection test failed:",l),!1}}async function fe(l){try{const o=`${x}${M.questionnaire.replace("{id}",l)}`;console.log("Fetching questionnaire by ID (public access):",l),console.log("Request URL:",o);const t=await b.get(o,{headers:{"Content-Type":"application/json"},timeout:1e4});return console.log("Questionnaire fetch response:",{status:t.status,statusText:t.statusText,data:t.data}),t.status===200&&t.data&&t.data!=="fail"?(console.log("Questionnaire fetched successfully:",t.data),t.data):(console.log("Questionnaire not found or failed to fetch"),null)}catch(o){if(console.error("Error fetching questionnaire:",o),b.isAxiosError(o)){const t=o.response?.status,n=o.response?.data?.message||o.message;console.log("Axios error details:",{status:t,message:n,url:o.config?.url,baseURL:o.config?.baseURL}),t===401?console.log("Authentication required, but this is public access"):t===404?console.log("Questionnaire not found (404)"):t===500?console.log("Server internal error (500)"):console.log("Other server error:",t)}return null}}async function ge(l){try{const o=`${x}${M.model.replace("{id}",l)}`;console.log("Fetching questionnaire model by ID (public access):",l),console.log("Request URL:",o);const t=await b.get(o,{headers:{"Content-Type":"application/json"},timeout:1e4});return console.log("Model fetch response:",t),t.status===200&&t.data&&t.data.modelId?(console.log("Model fetched successfully:",t.data),t.data):(console.log("Model not found or failed to fetch"),null)}catch(o){if(console.error("Error fetching model:",o),b.isAxiosError(o)){const t=o.response?.status;t===401?console.log("Authentication required, but this is public access"):t===404?console.log("Model not found"):console.log("Server error:",t)}return null}}async function ve(l){if($.has(l))return console.log("从缓存获取问题:",l),$.get(l)||null;try{const o=`${x}${M.question.replace("{id}",l)}`;console.log("Fetching question by ID (public access):",l),console.log("Request URL:",o);const t=await b.get(o,{headers:{"Content-Type":"application/json"},timeout:1e4});if(console.log("Question fetch response:",{status:t.status,statusText:t.statusText,data:t.data}),t.status===200&&t.data&&t.data!=="fail"){const n=t.data,a={id:String(n.id||n.questionId||l),type:String(n.type||n.questionType||"text"),title:String(n.title||n.questionTitle||n.questionTxt||"未命名问题"),description:String(n.description||n.questionTxt||""),shared:Number(n.shared||0),options:Array.isArray(n.options)?n.options.map(String):n.questionOptions?typeof n.questionOptions=="string"?JSON.parse(n.questionOptions):Array.isArray(n.questionOptions)?n.questionOptions.map(String):[]:[]};return $.set(l,a),a}else return console.log("Question not found or failed to fetch"),$.set(l,null),null}catch(o){if(console.error("Error fetching question:",o),b.isAxiosError(o)){const t=o.response?.status;console.log("Question fetch error details:",{status:t,message:o.response?.data?.message||o.message,questionId:l})}return $.set(l,null),null}}async function ye(l){try{console.log("开始解析问题数组，原始数据:",l),console.log("数据类型:",typeof l);let o;if(typeof l=="string"){if(console.log("数据长度:",l?.length),!l||l.trim()==="")return console.log("问题数组字符串为空或无效"),[];o=JSON.parse(l)}else console.log("数据已经是对象，直接使用"),o=l;if(console.log("JSON解析结果:",o),console.log("解析结果类型:",typeof o),console.log("是否为数组:",Array.isArray(o)),!Array.isArray(o))return console.log("解析结果不是数组"),[];if(console.log("解析后的数组长度:",o.length),o.length>0){console.log("数组第一个元素:",o[0]),console.log("第一个元素类型:",typeof o[0]);const t=o[0];if(typeof t=="string"){console.log("检测到问题ID数组格式，需要通过API获取问题数据"),console.log("问题ID列表:",o);const n=[];for(let a=0;a<o.length;a++){const f=o[a];console.log(`正在获取问题 ${a+1}/${o.length}, ID: ${f}`);try{const m=await ve(f);m?(n.push(m),console.log(`问题 ${f} 获取成功:`,m.title)):(console.warn(`问题 ${f} 获取失败，使用占位符`),n.push({id:f,type:"text",title:`问题 ${a+1} (加载失败)`,description:"题目加载失败，请联系管理员",options:[]}))}catch(m){console.error(`获取问题 ${f} 时出错:`,m),n.push({id:f,type:"text",title:`问题 ${a+1} (网络错误)`,description:"题目加载失败，请检查网络连接",options:[]})}}return console.log(`批量获取问题完成，成功获取 ${n.length} 个问题`),n}else if(typeof t=="object"&&t!==null)return console.log("检测到问题对象数组格式，直接解析"),o.map(n=>({id:String(n.id||n.questionId||Math.random()),type:String(n.type||n.questionType||"text"),title:String(n.title||n.questionTitle||"未命名问题"),description:String(n.description||n.questionTxt||""),options:Array.isArray(n.options)?n.options.map(String):n.questionOptions?typeof n.questionOptions=="string"?JSON.parse(n.questionOptions):n.questionOptions:[]}))}return console.log("没有匹配到任何解析逻辑，尝试直接使用数据"),Array.isArray(o)&&o.length===0?(console.log("数组为空，返回空结果"),[]):Array.isArray(o)&&o.length>0?(console.log("尝试通用解析..."),o.map((t,n)=>{if(typeof t=="object"&&t!==null){const a=t;return{id:String(a.id||a.questionId||`question_${n+1}`),type:a.type||a.questionType||"text",title:String(a.title||a.questionTitle||a.questionTxt||`问题 ${n+1}`),description:String(a.description||a.questionTxt||""),shared:Number(a.shared||0),options:Array.isArray(a.options)?a.options.map(String):[]}}return{id:`question_${n+1}`,type:"text",title:String(t),description:"",shared:0,options:[]}})):(console.log("所有解析方法都失败，返回空数组"),[])}catch(o){return console.error("解析公开问题数组失败:",o),console.error("错误详情:",o),[{id:"sample_1",type:"single",title:"您对我们的服务满意吗？",options:["非常满意","满意","一般","不满意","非常不满意"]},{id:"sample_2",type:"multiple",title:"您希望我们在哪些方面改进？（多选）",options:["服务质量","响应速度","产品功能","用户体验","价格"]},{id:"sample_3",type:"text",title:"请留下您的宝贵意见和建议："}]}}async function me(l,o){try{console.log("Submitting questionnaire answers to backend:",{questionnaireId:l,answers:o});const t=await he(),n={questionnaireId:l,answer:JSON.stringify(o),writerIp:t},a=await b.post(`${x}/answer/submit`,n,{headers:{"Content-Type":"application/json"}});return a.status===200?(console.log("Questionnaire answers submitted successfully"),{success:!0,message:"问卷提交成功，感谢您的参与！"}):(console.error("Failed to submit questionnaire answers:",a),{success:!1,message:"提交失败，请稍后重试"})}catch(t){return console.error("Error submitting questionnaire answers:",t),b.isAxiosError(t)?{success:!1,message:`提交失败：${t.response?.data?.message||t.response?.data||"网络错误"}`}:{success:!1,message:"网络错误，请检查网络连接"}}}async function he(){try{const l=["https://api.ipify.org?format=json","https://httpbin.org/ip","https://api.ip.sb/ip"];for(const o of l)try{const t=new AbortController,n=setTimeout(()=>t.abort(),3e3),a=await fetch(o,{signal:t.signal});clearTimeout(n);const f=await a.json();if(f.ip)return f.ip;if(f.origin)return f.origin;if(typeof f=="string")return f}catch(t){console.warn(`Failed to get IP from ${o}:`,t);continue}return"unknown"}catch(l){return console.warn("Failed to get client IP:",l),"unknown"}}async function be(l,o){try{const t=`questionnaire_draft_${l}`,n={answers:o,saveTime:new Date().toISOString()};return localStorage.setItem(t,JSON.stringify(n)),console.log("Public draft saved locally:",n),{success:!0,message:"草稿已保存到本地"}}catch(t){return console.error("Error saving public questionnaire draft:",t),{success:!1,message:"草稿保存失败"}}}function _e(l){try{const o=`questionnaire_draft_${l}`,t=localStorage.getItem(o);if(t){const n=JSON.parse(t);return console.log("Public draft loaded from local:",n),n.answers||null}return null}catch(o){return console.error("Error loading public questionnaire draft:",o),null}}const qe={class:"questionnaire-form"},we={key:0,class:"success-overlay"},Ae={class:"page-header"},ke={class:"header-content"},Ie={class:"page-title"},Se={key:0,class:"page-subtitle"},$e={key:0,class:"loading-section"},xe={key:1,class:"error-section"},Te={class:"error-content"},Pe={key:0,class:"error-debug-info"},De={class:"debug-details"},Ce={key:2,class:"questionnaire-container"},Me={class:"questionnaire-card"},Oe={class:"questionnaire-info"},Qe={class:"questionnaire-title"},Ne={class:"questionnaire-meta"},Ue={class:"meta-item"},Ee={class:"meta-item"},je={class:"question-header"},Re={class:"question-number"},Ve={class:"question-content"},Fe={class:"question-title"},Le={key:0,class:"question-description"},Be={class:"question-type"},Je={class:"type-badge"},Ke={class:"question-input"},ze={key:0,class:"input-group"},Ge=["id","onUpdate:modelValue","name","value"],He=["for"],We={class:"option-text"},Xe={key:1,class:"input-group"},Ye=["id","onUpdate:modelValue","value"],Ze=["for"],es={class:"option-text"},ss={key:2,class:"input-group"},ts=["onUpdate:modelValue"],os=["value"],ns={key:3,class:"input-group"},is=["onUpdate:modelValue"],as={class:"submit-section"},ls={class:"submit-actions"},rs=["disabled"],us=["disabled"],cs={key:3,class:"debug-panel"},ds={class:"debug-content"},ps={class:"message-content"},fs={key:2,class:"success-overlay"},gs=Z({__name:"questionnaire_form",setup(l){const o=se(),t=w(null),n=w([]),a=ee({}),f=w(!0),m=w(!1),T=w(!1),_=w({text:"",type:"success"}),v=A(()=>o.params.id),O=A(()=>!1),k=A(()=>({timestamp:new Date().toISOString(),questionnaireId:v.value,apiBaseUrl:"http://localhost:8081",questionnairePath:`/questionnaire/${v.value}`,modelPath:`/model/${v.value}`})),Q=A(()=>{if(!t.value)return!1;try{return pe(t.value.questionnaireStatus).active}catch{return!1}}),F=A(()=>Math.max(1,Math.ceil(n.value.length*.5))),N=A(()=>n.value.length>0&&n.value.some(i=>a[i.id]!==void 0&&a[i.id]!==""));async function U(){f.value=!0;try{console.log("开始加载问卷，ID:",v.value),console.log("API配置:",{baseUrl:"http://localhost:8081"});const i=await V();if(console.log("API连接状态:",i),!i){p("API服务不可用，请检查后端服务是否启动","error");return}const e=await fe(v.value);console.log("问卷数据:",e),e?(t.value=e,console.log("问卷加载成功:",e.questionnaireTitle),await L(),z(),p("问卷加载成功","success")):(console.error("问卷数据为空"),p("未找到指定的问卷，请检查问卷ID是否正确","error"))}catch(i){console.error("加载问卷异常:",i);let e="加载问卷失败";i instanceof Error&&(i.message.includes("404")?e="问卷不存在或已被删除":i.message.includes("500")?e="服务器内部错误":i.message.includes("Network Error")&&(e="网络连接失败，请检查后端服务")),p(e,"error")}finally{f.value=!1}}async function L(){if(!t.value){console.error("问卷数据为空，无法加载问题");return}try{console.log("开始加载问题，模型ID:",t.value.modelId);const i=await ge(t.value.modelId);if(console.log("问题模型数据:",i),i&&i.questionsArray){console.log("准备解析问题，questionsArray类型:",typeof i.questionsArray),console.log("questionsArray内容:",i.questionsArray);const e=await ye(i.questionsArray);n.value=e,console.log("问题解析结果:",e),console.log("解析后的问题数量:",e.length),e.forEach(r=>{r.type==="multiple"?a[r.id]=[]:a[r.id]=""}),console.log("问题加载完成:",n.value.length,"个问题"),e.length>0&&p(`问卷加载成功，共${e.length}个问题`,"success"),e.length===0&&p("该问卷暂无问题，请联系问卷发布者","warning")}else console.error("问题模型数据为空或缺少questionsArray"),console.log("模型对象键值:",i?Object.keys(i):"模型为null"),p("问题数据为空，请检查问卷配置","error")}catch(i){console.error("加载问题异常:",i);let e="加载问题失败";i instanceof Error&&(i.message.includes("404")?e="问题模型不存在":i.message.includes("500")&&(e="服务器错误，无法加载问题")),p(e,"error")}}async function B(){if(!N.value){p("请完成所有问题后再提交","warning");return}m.value=!0;try{const i=await me(v.value,a);if(i.success){T.value=!0;const e=`questionnaire_submitted_${v.value}`,r={submittedAt:new Date().toISOString(),questionnaireId:v.value,questionnaireTitle:t.value?.questionnaireTitle||"问卷调查"};ce(e,JSON.stringify(r),30),console.log("问卷提交标识已保存:",e),p(i.message,"success"),G()}else p(i.message,"error")}catch(i){console.error("Failed to submit questionnaire:",i),p("提交失败，请稍后重试","error")}finally{m.value=!1}}async function J(){try{const i=await be(v.value,a);p(i.message,i.success?"success":"error")}catch(i){console.error("Failed to save draft:",i),p("保存失败，请稍后重试","error")}}async function K(){try{p("正在测试API连接...","info"),await V()?(p("API连接测试成功！","success"),console.log("API连接正常:",{baseUrl:"http://localhost:8081"})):p("API连接测试失败：服务器无响应","error")}catch(i){console.error("API连接测试异常:",i),p("API连接测试异常：网络错误或服务器不可用","error")}}function z(){const i=_e(v.value);i&&(Object.assign(a,i),p("已加载上次保存的草稿","info"))}function G(){try{const i=`questionnaire_draft_${v.value}`;localStorage.removeItem(i)}catch(i){console.error("Failed to clear draft:",i)}}function H(){if(t.value){if(!Q.value)return"该问卷当前未开放，请联系问卷发布者。问卷可能已结束或尚未开始。"}else return"未找到指定的问卷，请检查链接是否正确。如果问题持续，请联系问卷发布者。";return"加载过程中发生未知错误，请刷新页面重试。"}function W(i){return{single:"单选题",multiple:"多选题",text:"问答题",dropdown:"下拉题"}[i]||i}function p(i,e){_.value.text=i,_.value.type=e,setTimeout(()=>{E()},3e3)}function E(){_.value.text=""}function X(i){return{success:"fas fa-check-circle",error:"fas fa-exclamation-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"}[i]||"fas fa-info-circle"}function Y(){const i=`questionnaire_submitted_${v.value}`;if(ne(i))try{const e=JSON.parse(ie(i)||"{}");return console.log("检测到问卷已提交:",e),T.value=!0,p(`您已经于 ${new Date(e.submittedAt).toLocaleString()} 提交过此问卷`,"info"),!0}catch(e){console.warn("解析提交状态Cookie失败:",e)}return!1}return te(()=>{Y()||U()}),(i,e)=>(c(),u("div",qe,[T.value?(c(),u("div",we,[...e[0]||(e[0]=[j('<div class="success-content" data-v-460dbe56><div class="success-icon" data-v-460dbe56><i class="fas fa-check-circle" data-v-460dbe56></i></div><h3 data-v-460dbe56>提交成功</h3><p data-v-460dbe56>感谢您的参与！您的回答已成功提交。</p><p class="submission-note" data-v-460dbe56><i class="fas fa-info-circle" data-v-460dbe56></i> 每个问卷只能提交一次，感谢您的配合。 </p></div>',1)])])):(c(),u(S,{key:1},[s("div",Ae,[s("div",ke,[s("h1",Ie,d(t.value?.questionnaireTitle||"问卷调查"),1),t.value?.questionnaireTitle?(c(),u("p",Se,"感谢您参与此次问卷调查")):q("",!0)])]),f.value?(c(),u("div",$e,[...e[1]||(e[1]=[s("div",{class:"loading-spinner"},[s("i",{class:"fas fa-spinner fa-spin"}),s("p",null,"正在加载问卷...")],-1)])])):!t.value||!Q.value?(c(),u("div",xe,[s("div",Te,[e[10]||(e[10]=s("i",{class:"fas fa-exclamation-triangle"},null,-1)),s("h3",null,d(t.value?"问卷未启动":"问卷不存在"),1),s("p",null,d(H()),1),O.value?(c(),u("div",Pe,[s("details",null,[e[8]||(e[8]=s("summary",null,"调试信息",-1)),s("div",De,[s("p",null,[e[2]||(e[2]=s("strong",null,"问卷ID:",-1)),g(" "+d(v.value),1)]),s("p",null,[e[3]||(e[3]=s("strong",null,"问卷数据:",-1)),g(" "+d(t.value?"已加载":"未加载"),1)]),s("p",null,[e[4]||(e[4]=s("strong",null,"问卷状态:",-1)),g(" "+d(t.value?.questionnaireStatus||"无"),1)]),s("p",null,[e[5]||(e[5]=s("strong",null,"问题数量:",-1)),g(" "+d(n.value.length),1)]),e[6]||(e[6]=s("p",null,[s("strong",null,"API配置:")],-1)),e[7]||(e[7]=s("ul",null,[s("li",null,"基础URL: http://localhost:8081"),s("li",null,"问卷端点: /questionnaire/:id"),s("li",null,"模型端点: /model/:id")],-1))])]),s("button",{onClick:U,class:"retry-btn"},[...e[9]||(e[9]=[s("i",{class:"fas fa-redo"},null,-1),g(" 重新加载 ",-1)])])])):q("",!0)])])):(c(),u("div",Ce,[s("div",Me,[s("div",Oe,[s("h2",Qe,d(t.value.questionnaireTitle),1),s("div",Ne,[s("span",Ue,[e[11]||(e[11]=s("i",{class:"fas fa-clock"},null,-1)),g(" 预计用时: "+d(F.value)+"分钟 ",1)]),s("span",Ee,[e[12]||(e[12]=s("i",{class:"fas fa-list-ol"},null,-1)),g(" 共"+d(n.value.length)+"道题目 ",1)])])]),s("form",{onSubmit:oe(B,["prevent"]),class:"questions-form"},[(c(!0),u(S,null,P(n.value,(r,I)=>(c(),u("div",{key:r.id,class:"question-item"},[s("div",je,[s("span",Re,d(I+1),1),s("div",Ve,[s("h3",Fe,d(r.title),1),r.description?(c(),u("p",Le,d(r.description),1)):q("",!0)]),s("div",Be,[s("span",Je,d(W(r.type)),1)])]),s("div",Ke,[r.type==="single"?(c(),u("div",ze,[(c(!0),u(S,null,P(r.options,(y,h)=>(c(),u("div",{key:h,class:"option-item"},[D(s("input",{id:`q${I}_${h}`,"onUpdate:modelValue":C=>a[r.id]=C,type:"radio",name:`question_${r.id}`,value:y,class:"radio-input"},null,8,Ge),[[ae,a[r.id]]]),s("label",{for:`q${I}_${h}`,class:"radio-label"},[e[13]||(e[13]=s("span",{class:"radio-custom"},null,-1)),s("span",We,d(y),1)],8,He)]))),128))])):r.type==="multiple"?(c(),u("div",Xe,[(c(!0),u(S,null,P(r.options,(y,h)=>(c(),u("div",{key:h,class:"option-item"},[D(s("input",{id:`q${I}_${h}`,"onUpdate:modelValue":C=>a[r.id]=C,type:"checkbox",value:y,class:"checkbox-input"},null,8,Ye),[[le,a[r.id]]]),s("label",{for:`q${I}_${h}`,class:"checkbox-label"},[e[14]||(e[14]=s("span",{class:"checkbox-custom"},null,-1)),s("span",es,d(y),1)],8,Ze)]))),128))])):r.type==="dropdown"?(c(),u("div",ss,[D(s("select",{"onUpdate:modelValue":y=>a[r.id]=y,class:"select-input"},[e[15]||(e[15]=s("option",{value:""},"请选择...",-1)),(c(!0),u(S,null,P(r.options,(y,h)=>(c(),u("option",{key:h,value:y},d(y),9,os))),128))],8,ts),[[re,a[r.id]]])])):r.type==="text"?(c(),u("div",ns,[D(s("textarea",{"onUpdate:modelValue":y=>a[r.id]=y,class:"text-input",placeholder:"请输入您的答案...",rows:"4"},null,8,is),[[ue,a[r.id]]])])):q("",!0)])]))),128)),s("div",as,[s("div",ls,[s("button",{type:"button",onClick:J,class:"btn btn-secondary",disabled:m.value},[...e[16]||(e[16]=[s("i",{class:"fas fa-save"},null,-1),g(" 保存草稿 ",-1)])],8,rs),s("button",{type:"submit",class:"btn btn-primary",disabled:m.value||!N.value},[e[17]||(e[17]=s("i",{class:"fas fa-paper-plane"},null,-1)),g(" "+d(m.value?"提交中...":"提交问卷"),1)],8,us)])])],32)])])),O.value?(c(),u("div",cs,[s("details",null,[e[23]||(e[23]=s("summary",null,"🔧 调试信息",-1)),s("div",ds,[s("p",null,[e[18]||(e[18]=s("strong",null,"问卷ID:",-1)),g(" "+d(k.value.questionnaireId),1)]),s("p",null,[e[19]||(e[19]=s("strong",null,"API基础URL:",-1)),g(" "+d(k.value.apiBaseUrl),1)]),s("p",null,[e[20]||(e[20]=s("strong",null,"问卷端点:",-1)),g(" "+d(k.value.questionnairePath),1)]),s("p",null,[e[21]||(e[21]=s("strong",null,"模型端点:",-1)),g(" "+d(k.value.modelPath),1)]),s("p",null,[e[22]||(e[22]=s("strong",null,"时间戳:",-1)),g(" "+d(k.value.timestamp),1)]),s("button",{onClick:K,class:"test-btn"},"测试API连接")])])])):q("",!0),_.value.text?(c(),u("div",{key:4,class:R(["message-container",_.value.type])},[s("div",ps,[s("i",{class:R(X(_.value.type))},null,2),s("span",null,d(_.value.text),1),s("button",{onClick:E,class:"message-close"},[...e[24]||(e[24]=[s("i",{class:"fas fa-times"},null,-1)])])])],2)):q("",!0)],64)),T.value?(c(),u("div",fs,[...e[25]||(e[25]=[j('<div class="success-content" data-v-460dbe56><div class="success-icon" data-v-460dbe56><i class="fas fa-check-circle" data-v-460dbe56></i></div><h3 data-v-460dbe56>提交成功</h3><p data-v-460dbe56>感谢您的参与！您的回答已成功提交。</p><p class="submission-note" data-v-460dbe56><i class="fas fa-info-circle" data-v-460dbe56></i> 每个问卷只能提交一次，感谢您的配合。 </p></div>',1)])])):q("",!0)]))}}),ms=de(gs,[["__scopeId","data-v-460dbe56"]]);export{ms as default};
